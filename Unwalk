-- Complete Rewrite: Animation Toggle + ESP System
local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

-- Debug function to help us track what's happening
local function debugPrint(message)
    print("[DEBUG] " .. message)
end

-- ========== ANIMATION SYSTEM ==========
local animationsEnabled = false
local animationConnection = nil
local toggleButton = nil

-- Simple animation toggle function
local function toggleAnimations()
    animationsEnabled = not animationsEnabled
    debugPrint("Toggling animations to: " .. (animationsEnabled and "ON" or "OFF"))
    
    -- Clean up any existing connection
    if animationConnection then
        animationConnection:Disconnect()
        animationConnection = nil
    end
    
    if not animationsEnabled then
        -- Block animations mode
        if localPlayer.Character then
            local humanoid = localPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                debugPrint("Found humanoid, setting up animation blocker")
                
                -- Stop all current animations
                for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
                    track:Stop()
                end
                
                -- Block new animations
                animationConnection = humanoid.AnimationPlayed:Connect(function(track)
                    debugPrint("Blocking animation: " .. track.Name)
                    track:Stop()
                end)
            else
                debugPrint("No humanoid found in character")
            end
        else
            debugPrint("No character found")
        end
    else
        -- Allow animations mode (just disconnect the blocker)
        debugPrint("Allowing animations")
    end
    
    -- Update button appearance
    if toggleButton then
        if animationsEnabled then
            toggleButton.Text = "Animation: ON"
            toggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)  -- Green
        else
            toggleButton.Text = "Animation: OFF"
            toggleButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)  -- Red
        end
    end
end

-- Handle character respawns
local function setupCharacterAnimations(character)
    wait(0.5) -- Wait for character to fully load
    debugPrint("Character loaded, current animation state: " .. (animationsEnabled and "ON" or "OFF"))
    
    if not animationsEnabled then
        -- Re-apply animation blocking
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            if animationConnection then
                animationConnection:Disconnect()
            end
            
            -- Stop current animations
            for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
                track:Stop()
            end
            
            -- Block new animations
            animationConnection = humanoid.AnimationPlayed:Connect(function(track)
                track:Stop()
            end)
        end
    end
end

-- ========== ESP SYSTEM ==========
local espEnabled = true
local espObjects = {}

local function createESP(player)
    if player == localPlayer then return end
    
    local character = player.Character
    if not character then
        debugPrint("No character found for player: " .. player.Name)
        return
    end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then
        debugPrint("No HumanoidRootPart found for: " .. player.Name)
        return
    end
    
    debugPrint("Creating ESP for: " .. player.Name)
    
    -- Create highlight
    local highlight = Instance.new("Highlight")
    highlight.Name = player.Name .. "_ESP"
    highlight.Adornee = character
    highlight.FillColor = Color3.fromRGB(255, 0, 0)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.7
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = character
    
    -- Create name tag
    local billboard = Instance.new("BillboardGui")
    billboard.Name = player.Name .. "_NameTag"
    billboard.Adornee = humanoidRootPart
    billboard.Size = UDim2.new(0, 100, 0, 30)
    billboard.StudsOffset = Vector3.new(0, 4, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 150
    billboard.Parent = character
    
    local usernameLabel = Instance.new("TextLabel")
    usernameLabel.Name = "Username"
    usernameLabel.Size = UDim2.new(1, 0, 1, 0)
    usernameLabel.BackgroundTransparency = 1
    usernameLabel.Text = player.Name
    usernameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    usernameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    usernameLabel.TextStrokeTransparency = 0
    usernameLabel.TextSize = 12
    usernameLabel.Font = Enum.Font.Gotham
    usernameLabel.Parent = billboard
    
    espObjects[player] = {
        highlight = highlight,
        billboard = billboard
    }
    
    debugPrint("ESP created successfully for: " .. player.Name)
end

local function removeESP(player)
    if espObjects[player] then
        if espObjects[player].highlight then
            espObjects[player].highlight:Destroy()
        end
        if espObjects[player].billboard then
            espObjects[player].billboard:Destroy()
        end
        espObjects[player] = nil
        debugPrint("ESP removed for: " .. player.Name)
    end
end

local function updateESP()
    for player, esp in pairs(espObjects) do
        if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            -- Update highlight if character changed
            if esp.highlight and esp.highlight.Adornee ~= player.Character then
                esp.highlight.Adornee = player.Character
            end
        else
            removeESP(player)
        end
    end
end

local function initializeESP()
    debugPrint("Initializing ESP system...")
    
    -- Create ESP for existing players
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer then
            createESP(player)
        end
    end
    
    -- Handle new players
    Players.PlayerAdded:Connect(function(player)
        debugPrint("New player joined: " .. player.Name)
        player.CharacterAdded:Connect(function()
            wait(1) -- Wait for character to load
            createESP(player)
        end)
    end)
    
    -- Handle players leaving
    Players.PlayerRemoving:Connect(function(player)
        debugPrint("Player left: " .. player.Name)
        removeESP(player)
    end)
    
    -- Handle character respawns for existing players
    for _, player in pairs(Players:GetPlayers()) do
        player.CharacterAdded:Connect(function()
            wait(1)
            if player ~= localPlayer then
                createESP(player)
            end
        end)
    end
    
    -- Update ESP positions
    RunService.Heartbeat:Connect(updateESP)
    
    debugPrint("ESP system initialized successfully")
end

-- ========== UI SYSTEM ==========
local function createToggleButton()
    local ScreenGui = Instance.new("ScreenGui")
    local ToggleButton = Instance.new("TextButton")
    
    ScreenGui.Parent = game.CoreGui
    ScreenGui.Name = "AnimationToggleGUI"
    ScreenGui.ResetOnSpawn = false
    
    ToggleButton.Size = UDim2.new(0, 150, 0, 40)
    ToggleButton.Position = UDim2.new(0, 10, 0, 10)
    ToggleButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)  -- Start as OFF (red)
    ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButton.Text = "Animation: OFF"
    ToggleButton.Font = Enum.Font.Gotham
    ToggleButton.TextSize = 14
    ToggleButton.BorderSizePixel = 0
    ToggleButton.ZIndex = 10
    
    -- Simple click handler
    ToggleButton.MouseButton1Click:Connect(function()
        debugPrint("Button clicked")
        toggleAnimations()
    end)
    
    ToggleButton.Parent = ScreenGui
    return ToggleButton
end

-- ========== MAIN INITIALIZATION ==========
debugPrint("Starting script initialization...")

-- Create the toggle button
toggleButton = createToggleButton()
debugPrint("Toggle button created")

-- Set up character event handlers
localPlayer.CharacterAdded:Connect(setupCharacterAnimations)

-- Initialize current character
if localPlayer.Character then
    setupCharacterAnimations(localPlayer.Character)
end

-- Initialize ESP
initializeESP()

-- Force initial animation state
toggleAnimations()

debugPrint("Script fully loaded and ready!")
debugPrint("Current state - Animations: " .. (animationsEnabled and "ON" or "OFF"))
debugPrint("ESP should be active for all players")
debugPrint("Click the red button to toggle animations ON/OFF")
